<!DOCTYPE HTML><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator</title>
    <!--mark |wiz_custom_css| for wizeditor replace it-->


<style id="wiz_custom_css">        html, body {            font-size: 15px;        }        body {            font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;            line-height: 1.6;            margin: 0;            padding: 20px 36px;            padding: 1.33rem 2.4rem;        }        h1, h2, h3, h4, h5, h6 {            margin: 20px 0 10px;            margin: 1.33rem 0 0.667rem;            padding: 0;            font-weight: bold;        }        h1 {            font-size: 21px;            font-size: 1.4rem;        }        h2 {            font-size: 20px;            font-size: 1.33rem;        }        h3 {            font-size: 18px;            font-size: 1.2rem;        }        h4 {            font-size: 17px;            font-size: 1.13rem;        }        h5 {            font-size: 15px;            font-size: 1rem;        }        h6 {            font-size: 15px;            font-size: 1rem;            color: #777777;            margin: 1rem 0;        }        div, p, ul, ol, dl, li {            margin: 0;        }        blockquote, table, pre, code {            margin: 8px 0;        }        ul, ol {            padding-left: 32px;            padding-left: 2.13rem;        }        blockquote {            padding: 0 12px;            padding: 0 0.8rem;        }        blockquote > :first-child {            margin-top: 0;        }        blockquote > :last-child {            margin-bottom: 0;        }        img {            border: 0;            max-width: 100%;            height: auto !important;            margin: 2px 0;        }        table {            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        td {            padding: 4px 8px;            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        @media screen and (max-width: 660px) {            body {                padding: 20px 18px;                padding: 1.33rem 1.2rem;            }        }        @media only screen and (-webkit-max-device-width: 1024px), only screen and (-o-max-device-width: 1024px), only screen and (max-device-width: 1024px), only screen and (-webkit-min-device-pixel-ratio: 3), only screen and (-o-min-device-pixel-ratio: 3), only screen and (min-device-pixel-ratio: 3) {            html, body {                font-size: 17px;            }            body {                line-height: 1.7;                padding: 0.75rem 0.9375rem;                color: #353c47;            }            h1 {                font-size: 2.125rem;            }            h2 {                font-size: 1.875rem;            }            h3 {                font-size: 1.625rem;            }            h4 {                font-size: 1.375rem;            }            h5 {                font-size: 1.125rem;            }            h6 {                color: inherit;            }            ul, ol {                padding-left: 2.5rem;            }            blockquote {                padding: 0 0.9375rem;            }        }</style><style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.09">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label { display: inline-block; padding-top: 7px; padding-bottom: 6px; line-height: 1.5;} .wiz-todo-label-checked {  color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style></head>

<body  style=""><p style="box-sizing: border-box; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">关于cocos2d-x下Lua调用C++的文档看了不少，但没有一篇真正把这事给讲明白了，我自己也是个初学者，摸索了半天，总结如下：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">cocos2d-x下Lua调用C++这事之所以看起来这么复杂、网上所有的文档都没讲清楚，是因为存在5个层面的知识点：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、在纯C环境下，把C函数注册进Lua环境，理解Lua和C之间可以互相调用的本质<br style="box-sizing: border-box;">2、在cocos2d-x项目里，把纯C函数注册进Lua环境，理解cocos2d-x是怎样创建Lua环境的、以及怎样得到这个环境并继续自定义它<br style="box-sizing: border-box;">3、了解为什么要使用toLua++来注册C++类<br style="box-sizing: border-box;">4、在纯C++环境下，使用toLua++来把一个C++类注册进Lua环境，理解toLua++的用法<br style="box-sizing: border-box;">5、在cocos2d-x项目里，使用cocos2d-x注册自身的方式把自定义的C++类注册进Lua环境，理解cocos2d-x是怎样通过bindings-generator脚本来封装toLua++的用法来节省工作量的</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">只有理解了前4层，在最后使用bindings-generator脚本的时候心里才会清清楚楚。而网上的文档，要么是只解释了第1层，要么是只填鸭式地告诉你第5层怎么用bindings-generator脚本，不仅中间重要的知识点一概不提，示例代码往往也写的不够简洁，这让我这种看见C++就眼晕的人理解起来大为头疼（不是我不会C++，而是我非常不接受C++的设计哲学，能避就避）。所以接下来的讲解我会对每一层知识点逐一讲解，示例代码也不求完整严谨，而是尽量用最简洁的方式把程序的关键点说明白。</p><hr style="box-sizing: content-box; height: 0px; margin: 1.5em auto; border-width: 2px 0px 0px; border-top-style: dotted; border-top-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><h2 id="articleHeader0" style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.2; color: rgb(51, 51, 51); margin-top: 1.5em; margin-bottom: 0px; font-size: 1.75em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); padding-bottom: 10px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">第一层：纯C环境下，把C函数注册进Lua环境</h2><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">直接看代码比啰哩啰嗦讲一大堆概念要清晰明了的多。建立一个a.lua和一个a.c文件，内容如下，一看就明白是怎么回事了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">a.lua</p><pre class="hljs coffeescript" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-lua" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">print</span>(foo(<span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">99</span>))
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">a.c</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lua.h&gt;</span><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lualib.h&gt;</span><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lauxlib.h&gt;</span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">foo</span><span class="hljs-params" style="box-sizing: border-box;">(lua_State *L)</span></span>{
  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> n = lua_tonumber(L, <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);

  lua_pushnumber(L, n + <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);

  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;
}

<span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">main</span><span class="hljs-params" style="box-sizing: border-box;">()</span></span>{
  lua_State *L = lua_open();

  luaL_openlibs(L);

  lua_register(L, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"foo"</span>, foo);

  luaL_dofile(L, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"a.lua"</span>);

  lua_close(L);

  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">怎么样，这代码简单吧？一看就明白，简单的不能再简单了。我特别烦示例代码里又是判断错误又是加代码注释的，本来看自己不会的代码就够吃力的了，还加那么多花花绿绿的干扰项，纯粹增加学习负担。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">在命令行下用gcc来编译并执行吧：</p><pre class="hljs cs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">gcc a.c -llua &amp;&amp; ./a.<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">out</span></code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">注意<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">-llua</code>选项是必要的，因为要连接lua的库。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">看完上面那段代码，再解释起来就容易多了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、要想注册进Lua环境，函数需要定义为这个样：<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">int xxx(lua_State *L)</code><br style="box-sizing: border-box;">2、使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_tonumber</code>、<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_tostring</code>等函数，来取得传入的参数，比如<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_tonumber(L, 1)</code>就是得到传入的第一个参数，且类型为数字<br style="box-sizing: border-box;">3、使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_pushnumber</code>、<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_pushstring</code>等函数，来将返回值压入Lua的环境中，因为Lua支持函数返回多个值，所以可以push多个返回值进Lua环境<br style="box-sizing: border-box;">4、最终函数返回的数字表示有多少个返回值被压入了Lua环境<br style="box-sizing: border-box;">5、使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_register</code>宏定义来将这个函数注册进Lua环境，Lua脚本里就可以用它了，大功告成！就这么简单！</p><hr style="box-sizing: content-box; height: 0px; margin: 1.5em auto; border-width: 2px 0px 0px; border-top-style: dotted; border-top-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><h2 id="articleHeader1" style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.2; color: rgb(51, 51, 51); margin-top: 1.5em; margin-bottom: 0px; font-size: 1.75em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); padding-bottom: 10px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">第二层：在cocos2d-x环境下，把C函数注册进Lua环境</h2><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">也简单：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/Classes/</code>目录下，找到<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">AppDelegate.cpp</code>文件。如果frameworks目录不存在，则需要参考这篇Blog：<a rel="nofollow" href="http://blog.segmentfault.com/hongliang/1190000000628902" style="box-sizing: border-box; background: transparent; color: rgb(0, 154, 97); text-decoration: none; outline: 0px;">用Cocos Code IDE写Lua，如何与项目中的C++代码和谐相处</a></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">AppDelegate.cpp文件中的关键代码如下：<br style="box-sizing: border-box;">```c++<br style="box-sizing: border-box;">auto engine = LuaEngine::getInstance();<br style="box-sizing: border-box;">ScriptEngineManager::getInstance()-&gt;setScriptEngine(engine);</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">LuaStack* <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">stack</span> = engine-&gt;getLuaStack();
<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">stack</span>-&gt;setXXTEAKeyAndSign(<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"2dxLua"</span>, <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">strlen</span>(<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"2dxLua"</span>), <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"XXTEA"</span>, <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">strlen</span>(<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"XXTEA"</span>));

<span class="hljs-comment" style="box-sizing: border-box; color: rgb(147, 161, 161);">//register custom function</span><span class="hljs-comment" style="box-sizing: border-box; color: rgb(147, 161, 161);">//LuaStack* stack = engine-&gt;getLuaStack();</span><span class="hljs-comment" style="box-sizing: border-box; color: rgb(147, 161, 161);">//register_custom_function(stack-&gt;getLuaState());</span></code></pre><pre class="hljs bash" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><br style="box-sizing: border-box;">可以看到cocos2d-x已经为我们留出了注册自定义C函数的位置，在注释代码后面这么写就可以了：
```cpp
lua_State *L = stack-&gt;getLuaState()；

lua_register(L, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"test_lua_bind"</span>, <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span>_lua_<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">bind</span>);
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">也可以通过<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">ScriptEngineManager</code>类从头取得当前的<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">LuaEngine</code>对象，然后再<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">getLuaStack()</code>方法得到封装的<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">LuaStack</code>对象，再调用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">getLuaState()</code>得到原始的<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_State</code>结构指针。只要知道了入口位置，其他一切就不成问题了，还是挺简单的。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">感兴趣的话可以去看一下<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">ScriptEngineManager</code>类的详细定义，在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/cocos2d-x/cocos/base/CCScriptSupport.h</code>文件中。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">BTW：这里还有一个小知识点，插入在AppDelegate.cpp中的自定义代码尽量写在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">COCOS2D_DEBUG</code>宏定义的判断前面，因为在调试环境下和真机环境下后续执行的代码是不一样的：</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">if</span> (COCOS2D_DEBUG&gt;0)</span><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (startRuntime())
        <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">true</span>;
<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">endif</span></span><span class="hljs-comment" style="box-sizing: border-box; color: rgb(147, 161, 161);">// 调试环境下代码就不会走到这里了</span>
    engine-&gt;executeScriptFile(ConfigParser::getInstance()-&gt;getEntryFile().c_str());
    <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">true</span>;
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">2、接下来，找个地方把<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind</code>函数定义写进去就算大功告成了。如果追求文件组织的优雅，按理说应该新建一个.c文件，但这样的话搞不好会把自己陷入到编译阶段的泥潭里，所以先不追求优雅，而就在AppDelegate.cpp文件末尾写上函数的定义就可以了，简单清楚明了：</p><pre class="hljs cs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">test_lua_bind</span><span class="hljs-params" style="box-sizing: border-box;">(lua_State *L)</span></span>{
    <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> number = lua_tonumber(L, <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);

    number = number + <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;

    lua_pushnumber(L, number);

    <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">3、大功告成，现在就可以在main.lua文件里使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind()</code>函数了：</p><pre class="hljs bash" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-lua" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">  <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">local</span> i = <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span>_lua_<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">bind</span>(<span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">99</span>)
  <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">print</span>(<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"lua bind: "</span> .. tostring(i))
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">4、如果是新建一个.c文件呢？把<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">AppDelegate.cpp</code>文件里<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind</code>函数定义的代码删掉，在头部<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">#include</code>后面加入：</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "test_lua_bind.h"</span></code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/Classes</code>目录下创建<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.h</code>文件，内容如下：</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">extern</span> <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"C"</span> {
<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "lua.h"</span><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "lualib.h"</span>
}

<span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">test_lua_bind</span><span class="hljs-params" style="box-sizing: border-box;">(lua_State *L)</span></span>;
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">再创建<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.c</code>文件，内容不变：</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-c" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "test_lua_bind.h"</span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">test_lua_bind</span><span class="hljs-params" style="box-sizing: border-box;">(lua_State *L)</span></span>{
    <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> number = lua_tonumber(L, <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);

    number = number + <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;

    lua_pushnumber(L, number);

    <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">此时用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos compile -p mac</code>命令编译，会发现<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.c</code>文件并没有被编译。这是当然的，普通的C/C++项目都是用Makefile来指定编译哪些.c/cpp文件的，当前的cocos2d-x项目虽然没有Makefile文件，但也是遵循这个原则的，也即肯定是有一个地方来指定所有要编译的文件的，需要在这个地方把<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.c</code>加进去，使得整个项目编译时把它也作为项目的一部分。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">答案是，cocos2d-x项目没有使用Makefile，而是非常聪明地使用了与具体环境相关的工程文件来作为命令行编译的环境，比如在编译iOS或Mac时就使用Xcode工程文件，在编译Android时就使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">Android.mk</code>文件。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">所以，添加好了<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.h</code>和<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.c</code>文件后，用Xcode打开项目，将这俩文件添加进工程中就行了。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/2a11a44b-66e2-410d-abbb-8c9b42940e4a.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">注意，千万不要勾选“Copy items into destination group's folder(if needed)”，因为cocos2d-x的Xcode工程目录组织不是常规的结构，一旦勾选这个，会导致这两个文件被拷贝至<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/proj.ios_mac</code>目录下，原来<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/Classes</code>目录下的文件就废掉了，这样的组织方式会乱，而且会影响Android那边对这俩文件的引用。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">把<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.h</code>和<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">test_lua_bind.cpp</code>这俩文件添加进Xcode工程后，再去命令行执行<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos compile -p mac</code>，编译就能成功了。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">网上有其他文章说还要修改Xcode工程的“User Headers Path”，这个经过试验是不需要的，哪怕把这俩文件放进新建的文件夹里也不需要，只要加入了Xcode工程即可，因为Xcode内部根本就不是按照文件夹的形式来组织文件的，它自己有一套叫做“Group”的东西。搞了好几年iOS开发，对Xcode的这个特性还是熟悉的。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/e7ce3e78-5686-4e5c-a3ee-9b29c4cd2a26.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">说到这就不禁要插一句对网上所有cocos2d-x文档的吐槽了，学习cocos2d-x的人水平实在是良莠不齐，大部分人似乎都是对游戏热衷的编程初学者，他们大多底子薄基础差，甚至一大部分人之前都没做过移动APP的开发，他们学习cocos2d-x只想知其然而不想知其所以然，给他们讲他们也看不明白（因为编程基础差），所以网上不少cocos2d-x文章都是只讲123步骤，而不告诉你为什么这么做，包括cocos2d-x官方的大量文档也是基于这个思路写的，中文和英文都一样。我看这些文章就特别痛苦，一边看一边心里就总是在想，“凭什么要这么做啊”、“这一步是为了什么啊”、“怎么这么麻烦啊”、“这个步骤明显不是最佳实践啊”、“解决这事为啥要这么麻烦”、“有更好的方法吗”，所以我这种初学者来看cocos2d-x文档就变成了不是单纯的学习，而是学习、质疑、求证、反思、优化的过程，对别人来说cocos2d-x的入门比较容易，到我这里反倒成了入门比较难、入门之后比较容易了，因为文档中的垃圾信息和无效信息实在是太多了，别人可以照单全收、以后懂了之后再慢慢剔除，我是必须从一开始就自己甄别垃圾、只保留最佳实践，这也是这篇Blog写的比较长的原因。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">扯远了。反正经过以上步骤，就完成了在cocos2d-x项目中把C函数注册进Lua环境这件事。至此，算是彻底搞懂了Lua和C函数之间的互相调用关系，也能在cocos2d-x的Lua环境中使用自定义的C函数了。但这还不够，因为一个正规的项目是需要狠好的组织结构的，全局C函数满天飞肯定是不行的，好一点的情况是把所有的C函数都在Lua中组织为模块注册进去，更好一点的情况是把C++类注册进Lua、并且C++类也是以Lua模块为组织方式注册进Lua环境的。这其实就是cocos2d-x自己把自己注册进Lua环境的方式。</p><hr style="box-sizing: content-box; height: 0px; margin: 1.5em auto; border-width: 2px 0px 0px; border-top-style: dotted; border-top-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><h2 id="articleHeader2" style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.2; color: rgb(51, 51, 51); margin-top: 1.5em; margin-bottom: 0px; font-size: 1.75em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); padding-bottom: 10px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">第三层：了解为什么要使用toLua++来注册C++类</h2><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">因为Lua的本质是C，不是C++，Lua提供给C用的API也都是基于面向过程的C函数来用的，要把C++类注册进Lua形成一个一个的table环境是不太容易一下子办到的事，因为这需要绕着弯地把C++类变成各种其他类型注册进Lua，相当于用面向过程的思维来维护一个面向对象的环境。这其中的细节就不去深究了，总之正是因为如此，所以单纯地手写<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_register()</code>等代码来注册C++类是行不通的、代价高昂的，所以需要借助toLua++这个工具。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这一层的知识点看似简单，但其实是非常重要的，只有理解了手工用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_register()</code>去注册C++类的难度，才能理解使用toLua++这类工具的必要性。只有理解了使用toLua++工具的必要性，才会潜下心来冷静地接受toLua++本身的优点和缺点。只有看到了toLua++本身的缺点和使用上的麻烦，才会真心理解cocos2d-x使用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">bindings-generator</code>脚本带来的好处。只有理解了<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">bindings-generator</code>脚本带来的好处，才能谅解这个脚本本身在使用上的一些不便之处。</p><hr style="box-sizing: content-box; height: 0px; margin: 1.5em auto; border-width: 2px 0px 0px; border-top-style: dotted; border-top-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><h2 id="articleHeader3" style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.2; color: rgb(51, 51, 51); margin-top: 1.5em; margin-bottom: 0px; font-size: 1.75em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); padding-bottom: 10px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">第四层：在纯C++环境下，使用toLua++来把一个C++类注册进Lua环境</h2><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">虽然终极方法是用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">bindings-generator</code>脚本来注册C++类进cocos2d-x的Lua环境，但理解toLua++本身的用法还是狠有必要的，只有知道了toLua++原本的用法，才能更好地理解cocos2d-x是怎么把自己的C++类都注册进Lua环境的，这不仅能让编程时的思路更加清晰，也能为日后在源码中寻找各种接口文档的过程中不至于看不懂那一大堆<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_beginmodule</code>、<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_function</code>是什么意思。影响程序员学习提高的一大障碍就是忽略那些一知半解的代码，不去刨根究底地搞明白。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">使用toLua++的标准做法是：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、准备好自己的C++类，该怎么写就怎么写<br style="box-sizing: border-box;">2、仿造这个类的.h文件，改一个.pkg文件出来，具体格式要按照toLua++的规定，比如移除所有的private成员等<br style="box-sizing: border-box;">3、建一个专门用来桥接C++和Lua之间的C++类，使用特殊的函数签名来写它的.h文件，.cpp文件不写，等着toLua++来生成<br style="box-sizing: border-box;">4、给这个桥接的C++类写一个.pkg文件，按照toLua++的特殊格式来写，目的是把真正做事的C++类给定义进去<br style="box-sizing: border-box;">5、在命令行下用toLua++生成桥接类的.cpp文件<br style="box-sizing: border-box;">6、程序入口引用这个桥接类，执行生成的桥接函数，Lua环境中就可以使用真正做事的C++类了</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">toLua++这种自己手写.pkg文件的方式古老又难受，所以我没有仔细地去学习，这套流程放在10年前的那个年代是没有太大问题的，作者怎么规定就怎么用好了，但是放在2014年的今天，任何程序的架构设计都讲究学习成本低、轻量化、符合以往的习惯，因此toLua++用起来我觉得其实是难受的。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">下面我以尽量最少的代码来走一遍toLua++的流程，注意这是在纯C++环境下，跟任何框架都没关系，也不考虑内存释放等细节：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">MyClass.h</p><pre class="hljs cs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">MyClass</span> {
<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span>:
  MyClass() {};

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">foo</span><span class="hljs-params" style="box-sizing: border-box;">(<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> i)</span></span>;
};
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">MyClass.cpp</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "MyClass.h"</span><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> MyClass::foo(<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> i)
{
  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> i + <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">100</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">MyClass.pkg</p><pre class="hljs cs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">MyClass</span>
{
  MyClass();
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">foo</span><span class="hljs-params" style="box-sizing: border-box;">(<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> i)</span></span>;
};
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">MyLuaModule.h</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">extern</span> <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"C"</span> {
<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "tolua++.h"</span>
}

<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "MyClass.h"</span><span class="hljs-function" style="box-sizing: border-box;">TOLUA_API <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">tolua_MyLuaModule_open</span><span class="hljs-params" style="box-sizing: border-box;">(lua_State* tolua_S)</span></span>;
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">MyLuaModule.pkg</p><pre class="hljs ruby" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-variable" style="box-sizing: border-box; color: rgb(181, 137, 0);">$#</span><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">include</span> <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"MyLuaModule.h"</span><span class="hljs-variable" style="box-sizing: border-box; color: rgb(181, 137, 0);">$pfile</span> <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"MyClass.pkg"</span></code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">main.cpp</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">extern</span> <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"C"</span> { 
<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lua.h&gt;</span><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lualib.h&gt;</span><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> &lt;lauxlib.h&gt;</span>
}

<span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "MyLuaModule.h"</span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">main</span><span class="hljs-params" style="box-sizing: border-box;">()</span></span>{
  lua_State *L = lua_open();

  luaL_openlibs(L);

  tolua_MyLuaModule_open(L);

  luaL_dofile(L, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"main.lua"</span>);

  lua_close(L);

  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">main.lua</p><pre class="hljs bash" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-lua" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">local</span> <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span> = MyClass:new()
<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">print</span>(<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span>:foo(<span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">99</span>))
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">先在命令行下执行：</p><pre class="hljs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">tolua++ -o MyLuaModule.cpp MyLuaModule.pkg
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">此命令用来生成桥接文件MyLuaModule.cpp。注意命令行中-o参数的顺序不能随意摆放，从这个小事也能看出tolua++的古老和难用</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">生成好MyLuaModule.cpp文件后，就能看到它里面的那一大堆桥接代码了，比如<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_beginmodule</code>、<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_function</code>等。以后看到这些东西就不陌生了，就明白这些函数只是toLua++用来做桥接的必备代码了，简单看一下代码，就理解toLua++是怎样把MyClass这个C++类注册进Lua中的了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/77a553df-05a7-4ddc-8d4d-b7024ef3b3f7.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">接下来，用g++来编译：</p><pre class="hljs" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">g++ MyClass.cpp MyLuaModule.cpp main.cpp -llua -ltolua++
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">默认就生成了<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">a.out</code>文件，执行，就能看到main.lua的执行结果了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/4845bf2a-08bb-4317-abad-3490fb374323.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">至此，对toLua++的运作原理心里就透亮了，无非就是：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、把自己该写的类写好<br style="box-sizing: border-box;">2、写个.pkg文件，告诉toLua++这个类暴露出哪些接口给Lua环境<br style="box-sizing: border-box;">3、再写个桥接的.h和.pkg文件，让toLua++去生成桥接代码<br style="box-sizing: border-box;">4、在程序里使用这个桥接代码，类就注册进Lua环境里了</p><hr style="box-sizing: content-box; height: 0px; margin: 1.5em auto; border-width: 2px 0px 0px; border-top-style: dotted; border-top-color: rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><h2 id="articleHeader4" style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.2; color: rgb(51, 51, 51); margin-top: 1.5em; margin-bottom: 0px; font-size: 1.75em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); padding-bottom: 10px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">第五层：使用cocos2d-x的方式来将C++类注册进Lua环境</h2><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">cocos2d-x在2.x版本里就是用toLua++和.pkg文件这么把自己注册进Lua环境里的。不过这种方法明显笨拙，既要写真正做事的.pkg文件，也要写桥接的.pkg文件和.h文件，工作量又大又枯燥。所以从cocos2d-x 3.x开始，用bindings-generator脚本代替了toLua++。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">bindings-generator脚本的工作机制是：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、不用挨个类地写桥接.pkg和.h文件了，直接定义一个ini文件，告诉脚本哪些类的哪些方法要暴露出来，注册到Lua环境里的模块名是什么，就行了，等于将原来的每个类乘以3个文件的工作量变成了所有类只需要1个.ini文件<br style="box-sizing: border-box;">2、摸清了toLua++工具的生成方法，改由Python脚本动态分析C++类，自动生成桥接的.h和.cpp代码，不调用tolua++命令了<br style="box-sizing: border-box;">3、虽然不再调用tolua++命令了，但是底层仍然使用toLua++的库函数，比如<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_function</code>，bindings-generator脚本生成的代码就跟使用toLua++工具生成的几乎一样</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">bindings-generator脚本掌握了生成toLua++桥接代码的主动权，不仅可以省下大量的.pkg和.h文件，而且可以更好地插入自定义代码，达到cocos2d-x环境下的一些特殊目的，比如内存回收之类的。所以cocos2d-x从3.x开始放弃了toLua++和.pkg而改用了自己写的bindings-generator脚本是非常值得赞赏的聪明做法。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">接下来说怎么用bindings-generator脚本：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">1、写自己的C++类，按照cocos2d-x的规矩，继承cocos2d::Ref类，以便使用cocos2d-x的内存回收机制。当然不这么干也行，但是不推荐，不然在Lua环境下对象的释放狠麻烦。<br style="box-sizing: border-box;">2、编写一个.ini文件，让bindings-generator可以根据这个配置文件知道C++类该怎么暴露出来<br style="box-sizing: border-box;">3、修改bindings-generator脚本，让它去读取这个.ini文件<br style="box-sizing: border-box;">4、执行bindings-generator脚本，生成桥接C++类方法<br style="box-sizing: border-box;">5、用Xcode将自定义的C++类和生成的桥接文件加入工程，不然编译不到<br style="box-sizing: border-box;">6、修改AppDelegate.cpp，执行桥接方法，自定义的C++类就注册进Lua环境里了</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">看着步骤挺多，其实都狠简单。下面一步一步来。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">首先是自定义的C++类。我习惯将文件保存在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/Classes/</code>目录下：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">frameworks/runtime-src/Classes/MyClass.h</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "cocos2d.h"</span><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">using</span> <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">namespace</span> cocos2d;

<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">class</span> MyClass : <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span> Ref
{
<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span>:
  MyClass()   {};
  ~MyClass()  {};
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">init</span><span class="hljs-params" style="box-sizing: border-box;">()</span> </span>{ <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">true</span>; };
  CREATE_FUNC(MyClass);

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">foo</span><span class="hljs-params" style="box-sizing: border-box;">(<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> i)</span></span>;
};
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">frameworks/runtime-src/Classes/MyClass.cpp</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-preprocessor" style="box-sizing: border-box; color: rgb(203, 75, 22);">#<span class="hljs-keyword" style="box-sizing: border-box;">include</span> "MyClass.h"</span><span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> MyClass::foo(<span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> i)
{
  <span class="hljs-keyword" style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> i + <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">100</span>;
}
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">然后编写.ini文件。在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/cocos2d-x/tools/tolua/</code>目录下能看到<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">genbindings.py</code>脚本和一大堆.ini文件，这些就是bindings-generator的实际执行环境了。随便找一个内容比较少的.ini文件，复制一份，重新命名为MyClass.ini。大部分内容都可以凑合不需要改，这里仅列出必须要改的重要部分：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">frameworks/cocos2d-x/tools/tolua/MyClass.ini</p><pre class="hljs ini" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-title" style="box-sizing: border-box; color: rgb(38, 139, 210);">[MyClass]</span><span class="hljs-setting" style="box-sizing: border-box;">prefix           = <span class="hljs-value" style="box-sizing: border-box;">MyClass</span></span><span class="hljs-setting" style="box-sizing: border-box;">target_namespace = <span class="hljs-value" style="box-sizing: border-box;">my</span></span><span class="hljs-setting" style="box-sizing: border-box;">headers          = <span class="hljs-value" style="box-sizing: border-box;">%(cocosdir)s/../runtime-src/Classes/MyClass.h</span></span><span class="hljs-setting" style="box-sizing: border-box;">classes          = <span class="hljs-value" style="box-sizing: border-box;">MyClass</span></span></code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">也即在MyClass.ini中指定MyClass.h文件的位置，指定要暴露出来的类，指定注册进Lua环境的模块名。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">注意，这个地方我踩了个坑。如果.ini配置文件中存在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">macro_judgement = ...</code>宏定义，要特别小心，我第一次是从<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos2dx_controller.ini</code>文件复制来的，结果没注意<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">macro_judgement</code>，导致生成的桥接类文件加入了不该加入的宏，只在iOS和Android平台上才起作用，对Mac平台无效，这个要特别注意。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">然后修改<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">genbindings.py</code>文件129行附近，将MyClass.ini文件加进去：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">frameworks/cocos2d-x/tools/tolua/genbindings.py</p><pre class="hljs coffeescript" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-python" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">cmd_args = {<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'cocos2dx.ini'</span> : (<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'cocos2d-x'</span>, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'lua_cocos2dx_auto'</span>), \
            <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'MyClass.ini'</span> : (<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'MyClass'</span>, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">'lua_MyClass_auto'</span>), \
            ...
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">（其实这一步本来是可以省略的，只要让genbindings.py脚本自动搜寻当前目录下的所有ini文件就行了，不知道将来cocos2d-x团队会不会这样优化）</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">至此，生成桥接文件的准备工作就做好了，执行genbindings.py脚本：</p><pre class="hljs nginx" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-title" style="box-sizing: border-box; color: rgb(133, 153, 0);">python</span> genbindings.py
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">（在Mac系统上可能会遇到缺少yaml、Cheetah包的问题，安装这些Python包狠简单，先<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">sudo easy_install pip</code>，把pip装好，然后用pip各种<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">pip search</code>、<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">sudo pip install</code>就可以了）</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">成功执行genbindings.py脚本后，会在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/cocos2d-x/cocos/scripting/lua-bindings/auto/</code>目录下看到新生成的文件：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/5b9b7d67-5d39-4f34-8ce4-1b730768727f.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">每次执行genbindings.py脚本时间都挺长的，因为它要重新处理一遍所有的.ini文件，建议大胆修改脚本文件，灵活处理，让它每次只处理需要的.ini文件就可以了，比如像这个样子：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/05889510-5c60-4d81-8380-db4b41b51dd3.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">在<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/cocos2d-x/cocos/scripting/lua-bindings/auto/</code>目录下观察一下生成的C++桥接文件<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_MyClass_auto.cpp</code>，里面的注册函数名字为<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">register_all_MyClass()</code>，这就是将MyClass类注册进Lua环境的关键函数：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/7e62df11-85ca-4124-a721-f0cf1086f151.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">编辑<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/runtime-src/Classes/AppDelegate.cpp</code>文件，首先在文件头加入对<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_MyClass_auto.hpp</code>文件的引用：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/976697bb-9304-4e46-a7d7-10c1b1ccfc4e.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">然后在正确的代码位置加入对<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">register_all_MyClass</code>函数的调用：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/6f84fb3a-e343-41ab-ac5f-5a53c6a61510.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">最后在执行编译前，将新加入的这几个C++文件都加入到Xcode工程中，使得编译环境知道它们的存在：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/456f2131-6d49-4ae8-8cc8-567a75a324e4.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这其中还有一个小坑，由于<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">lua_MyClass_auto.cpp</code>文件要引用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">MyClass.h</code>文件，而这俩文件分属于不同的子项目，互相不认识头文件的搜寻路径，因此需要手工修改一下<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos2d_lua_bindings.xcodeproj</code>子项目的<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">User Header Search Paths</code>配置。特别注意一共有几个<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">../</code>：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/76a09e7c-7f40-489a-b65e-9740dfd1f3d0.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">最后，就可以用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos compile -p mac</code>命令重新编译整个项目了，不出意外的话编译一定是成功的。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">修改main.lua文件中，尝试调用一下MyClass类：</p><pre class="hljs bash" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-lua" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;"><span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">local</span> <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span> = my.MyClass:create()
<span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">print</span>(<span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"lua bind: "</span> .. <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">test</span>:foo(<span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">99</span>))
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">然后执行程序（用<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">cocos rum -p mac</code>或在Cocos Code IDE中均可），见证奇迹的时刻~~~~咦我擦？！程序崩溃！为毛？</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/a531fe89-0a09-4fbc-bbd6-41afeffed2e5.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">这是我作为cocos2d-x初学者遇到的最大的坑，坑了我整整一天半，具体的研究细节就不详细说了，总之罪魁祸首是cocos2d-x框架中的<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">CCLuaEngine.cpp</code>文件的这段代码：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/858486d8-9472-461e-a51c-2b5775da15fd.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">原因是<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">executeScriptFile</code>函数执行时，对当前Lua环境中的栈进行了清理，当<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">register_all_MyClass</code>函数被调用时，Lua栈是全空的状态，函数内部执行到<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">tolua_module</code>函数调用时就崩溃了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/4f9a3f81-d0d2-4f7f-8aa4-694eb0b5cb85.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">解决办法是修改AppDelegate.cpp为这个样子：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/b865d417-e6bc-427a-a542-4b6c5b04bf2d.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">文本形式的代码如下：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">AppDelegate.cpp</p><pre class="hljs cpp" style="box-sizing: border-box; overflow: auto; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 0.93em; padding: 1em; margin-top: 1.5em; margin-bottom: 1.5em; line-height: 1.3; word-break: break-all; word-wrap: break-word; color: rgb(101, 123, 131); border: none; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; max-height: 35em; position: relative; orphans: 2; widows: 2;"><code class="lang-cpp" style="box-sizing: border-box; font-family: 'Source Code Pro', Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 1em; color: inherit; background-image: none; padding: 0px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; white-space: inherit; overflow-wrap: normal; background-position: initial initial; background-repeat: initial initial;">lua_State *L = <span class="hljs-built_in" style="box-sizing: border-box; color: rgb(38, 139, 210);">stack</span>-&gt;getLuaState();
lua_getglobal(L, <span class="hljs-string" style="box-sizing: border-box; color: rgb(42, 161, 152);">"_G"</span>);
register_all_MyClass(L);
lua_settop(L, <span class="hljs-number" style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>);
</code></pre><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">重新编译并执行，程序就正确执行了：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img  src="cocos2dx-lua 调用自定义c++类网上参考资料  bindings-generator_files/1da53c79-0b7d-4b8b-bdd9-41515d00ac14.png" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">至此，就彻底搞清楚应该怎样在cocos2d-x项目里绑定一个C函数或者C++类到Lua环境中了，感兴趣的话可以再进一步深入研究Lua内部metatable的运作原理、类对象的生成与释放、以及垃圾回收。我自己也是刚接触cocos2d-x不到一个星期，理解不深，以上难免会有用词不当或理解错误的地方，如有错误请多包涵。</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);">后记补充：如果C++类定义了namespace，则需要修改<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">frameworks/cocos2d-x/tools/bindings-generator/targets/lua/conversions.yaml</code>文件，定义namespace与Lua之间的映射关系，否则会报<code style="box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.93em; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); padding: 2px 4px; border-radius: 3px;">conversion wasn't set</code>错误：</p><p style="box-sizing: border-box; margin-top: 1.5em; margin-bottom: 1.5em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'PingFang SC', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif; font-size: 14px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);"><img data-src="/img/bVc6A1" src="C:\img\bVc6A1" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; padding: 3px; cursor: pointer; display: inline; position: static !important;"></p><br><div style="color:gray"><small>来源：&nbsp;<a href="https://segmentfault.com/a/1190000000631630">https://segmentfault.com/a/1190000000631630</a></small></div></body></html>