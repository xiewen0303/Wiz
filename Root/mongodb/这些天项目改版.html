<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<!--defaultCSS-->
<title>这些天项目改版</title>



<style type="text/css" id="wiz_custom_css">
body
{
    font-family: 微软雅黑,"Microsoft YaHei", Georgia,Helvetica,Arial,sans-serif,宋体, PMingLiU,serif;
    font-size: 10.5pt;
    line-height: 1.5;
}
html, body
{
    
    
}
h1 {
    font-size:1.5em;
    font-weight:bold;
}
h2 {
    font-size:1.4em;
    font-weight:bold;
}
h3 {
    font-size:1.3em;
    font-weight:bold;
}
h4 {
    font-size:1.2em;
    font-weight:bold;
}
h5 {
    font-size:1.1em;
    font-weight:bold;
}
h6 {
    font-size:1.0em;
    font-weight:bold;
}
img {
    border:0;
    max-width: 100%;
    height: auto !important;
}
blockquote {
    margin-top:0px;
    margin-bottom:0px;
}
table {
    border-collapse:collapse;
    border:1px solid #bbbbbb;
}
td {
    border-collapse:collapse;
    border:1px solid #bbbbbb;
}
</style>

<style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.09">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label { display: inline-block; padding-top: 7px; padding-bottom: 6px; line-height: 1.5;} .wiz-todo-label-checked {  color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style></head>

<body  style=""><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;这些天项目改版，时间比较紧，博客也就没跟得上，还望大家见谅。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; 好，今天分享下mongodb中关于索引的基本操作，我们日常做开发都避免不了要对程序进行性能优化，而程序的操作无非就是CURD，通常我们</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">又会花费50%的时间在R上面，因为Read操作对用户来说是非常敏感的，处理不好就会被人唾弃，呵呵。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; 从算法上来说有5种经典的查找，具体的可以参见我的算法速成系列，这其中就包括我们今天所说的“索引查找”，如果大家对sqlserver比较了解</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">的话，相信索引查找能给我们带来什么样的性能提升吧。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;我们首先插入10w数据，上图说话：</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/47acad6a-697a-444c-8258-538cad618abe.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">一：性能分析函数（explain）</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">好了，数据已经插入成功，既然我们要做分析，肯定要有分析的工具，幸好mongodb中给我们提供了一个关键字叫做“explain"，那么怎么用呢？</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">还是看图，注意，这里的name字段没有建立任何索引，这里我就查询一个“name10000”的姓名。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/9e314e2c-d298-4503-8da8-357deceb057e.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;仔细看红色区域，有几个我们关心的key。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;cursor: &nbsp; &nbsp; &nbsp; 这里出现的是”BasicCursor",什么意思呢，就是说这里的查找采用的是“表扫描”，也就是顺序查找，很悲催啊。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;nscanned: &nbsp;这里是10w，也就是说数据库浏览了10w个文档，很恐怖吧，这样玩的话让人受不了啊。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;n: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这里是1，也就是最终返回了1个文档。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;millis: &nbsp; &nbsp; &nbsp; &nbsp;这个就是我们最最最....关心的东西，总共耗时114毫秒。&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">二：建立索引（ensureIndex）</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp;在10w条这么简单的集合中查找一个文档要114毫秒有一点点让人不能接收，好，那么我们该如何优化呢？mongodb中给</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">我们带来了索引查找，看看能不能让我们的查询一飞冲天.....</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp;<img src="这些天项目改版_files/46f8f7d1-daf7-4d6f-beb1-40cf89cf30b9.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; 这里我们使用了ensureIndex在name上建立了索引。”1“：表示按照name进行升序，”-1“：表示按照name进行降序。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">我的神啊，再来看看这些敏感信息。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;cursor: &nbsp; &nbsp; &nbsp; 这里出现的是”BtreeCursor"，这么牛X，mongodb采用B树的结构来存放索引，索引名为后面的“name_1"。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;nscanned: &nbsp;我擦，数据库只浏览了一个文档就OK了。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;n: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 直接定位返回。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp;millis: &nbsp; &nbsp; &nbsp; &nbsp;看看这个时间真的不敢相信，秒秒杀。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">通过这个例子相信大家对索引也有了感官方面的认识了吧。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">三：唯一索引</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp;和sqlserver一样都可以建立唯一索引，重复的键值自然就不能插入，在mongodb中的使用方法是：</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">db.person.ensureIndex({"name":1},{"unique":true})。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/a251e32e-d485-4380-885e-ce37de276298.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">四：组合索引</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp;有时候我们的查询不是单条件的，可能是多条件，比如查找出生在‘1989-3-2’名字叫‘jack’的同学，那么我们可以建立“姓名”和"生日“</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">的联合索引来加速查询。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/a55aba1c-2f7d-476e-b4c4-6bacd48155ee.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">看到上图，大家或者也知道name跟birthday的不同，建立的索引也不同，升序和降序的顺序不同都会产生不同的索引，</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">那么我们可以用getindexes来查看下person集合中到底生成了那些索引。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/a7263943-18ee-4719-a11b-86284ed5578f.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">此时我们肯定很好奇，到底查询优化器会使用哪个查询作为操作，呵呵，还是看看效果图：</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/0923bcdc-6246-47ad-a4a8-00c98eb6a2de.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">看完上图我们要相信查询优化器，它给我们做出的选择往往是最优的，因为我们做查询时，查询优化器会使用我们建立的这些索引来创建查询方案，</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">如果某一个先执行完则其他查询方案被close掉，这种方案会被mongodb保存起来，当然如果非要用自己指定的查询方案，这也是</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">可以的，在mongodb中给我们提供了hint方法让我们可以暴力执行。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/4e047022-f8da-472c-a06d-f25668acd213.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp;</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">五： 删除索引</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">&nbsp; &nbsp; &nbsp;可能随着业务需求的变化，原先建立的索引可能没有存在的必要了，可能有的人想说没必要就没必要呗，但是请记住，索引会降低CUD这三</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);">种操作的性能，因为这玩意需要实时维护，所以啥问题都要综合考虑一下，这里就把刚才建立的索引清空掉来演示一下:dropIndexes的使用。</p><p style="margin: 10px auto; padding: 0px; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13.92px; line-height: 20.88px; widows: 1; background-color: rgb(255, 255, 255);"><img src="这些天项目改版_files/2a739220-2a05-4afa-b9d2-68df657d1a12.png" alt="" style="margin: 0px; padding: 0px; max-width: 1000px;"></p><br><div style="color:gray"><small>来源：&nbsp;&lt;<a href="http://www.cnblogs.com/huangxincheng/archive/2012/02/29/2372699.html">http://www.cnblogs.com/huangxincheng/archive/2012/02/29/2372699.html</a><small>&gt;</small></small></div><small><small>&nbsp;</small></small></body></html>